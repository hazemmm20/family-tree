<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title><%= mode === "new" ? "إضافة شخص" : "تعديل شخص" %> - لوحة الإدارة</title>

  <!-- Theme (same system) -->
  <script src="/theme.js"></script>

  <!-- Fonts + Icons + Tailwind -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700;800;900&family=Amiri:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#1f637a",
            accent: "#cfae61",
            gold: "#cfae61",
            "background-light": "#f8f8f6",
            "bg-charcoal": "#0F1115",
            "bg-card": "#16191E",
            "text-cream": "#FDFBF7",
            "muted-slate": "#94A3B8",
            paper: "#FDFBF7",
          },
          fontFamily: {
            display: ["Cairo", "sans-serif"],
            amiri: ["Amiri", "serif"],
          },
          backgroundImage: {
            "islamic-pattern": "url(\"data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%231f637a' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E\")",
          }
        }
      }
    };
  </script>

  <style>
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 6px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    .dark ::-webkit-scrollbar-thumb { background: #2D3139; }
    .dark ::-webkit-scrollbar-thumb:hover { background: #cfae61; }

    html.dark .dark-toggle-icon-moon { display: none; }
    html:not(.dark) .dark-toggle-icon-sun { display: none; }

    .gold-glow{
      box-shadow:
        0 20px 50px -12px rgba(0,0,0,.55),
        0 0 40px rgba(207,174,97,.12),
        0 0 80px rgba(207,174,97,.06);
    }
  </style>

  <!-- Theme sync before paint -->
  <script>
    (function () {
      const saved = localStorage.getItem("theme") || "dark";
      document.documentElement.setAttribute("data-theme", saved);
      document.documentElement.classList.toggle("dark", saved === "dark");

      const obs = new MutationObserver(() => {
        const t = document.documentElement.getAttribute("data-theme") || "dark";
        document.documentElement.classList.toggle("dark", t === "dark");
      });
      obs.observe(document.documentElement, { attributes: true, attributeFilter: ["data-theme"] });
    })();
  </script>
</head>

<body class="bg-background-light dark:bg-bg-charcoal text-[#272522] dark:text-text-cream font-display min-h-screen flex flex-col overflow-x-hidden selection:bg-gold selection:text-bg-charcoal transition-colors duration-300">

  <!-- Header (مطابق ستايل الجديد) -->
  <header class="sticky top-0 z-50 w-full bg-white/90 dark:bg-[#0F1115]/95 backdrop-blur-md border-b border-[#e5e7eb] dark:border-white/5">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-20">

        <div class="flex items-center gap-4">
          <div class="flex items-center gap-3">
            <img class="h-10 w-auto hidden dark:block" src="/assets/logo-dark.svg" alt="شعار العائلة" />
            <img class="h-10 w-auto block dark:hidden" src="/assets/logo-light.svg" alt="شعار العائلة" />
          </div>

          <div class="hidden sm:flex flex-col items-start">
            <h1 class="text-xl font-extrabold text-primary dark:text-gold leading-none tracking-tight">لوحة الإدارة</h1>
            <span class="text-[10px] font-bold text-accent uppercase tracking-[0.2em]">
              <%= mode === "new" ? "إضافة شخص" : "تعديل شخص" %>
            </span>
          </div>
        </div>

        <div class="flex items-center gap-4 md:gap-8">
          <nav class="hidden md:flex gap-8 items-center" aria-label="التنقل الرئيسي">
            <a class="text-sm font-medium text-primary dark:text-gray-400 hover:text-accent transition-colors" href="/">الشجرة</a>
            <a class="text-sm font-medium text-primary dark:text-gray-400 hover:text-accent transition-colors" href="/about">نبذة</a>
            <a class="text-sm font-medium text-primary dark:text-gray-400 hover:text-accent transition-colors" href="/honor">قائمة السير الذاتية</a>
            <a class="text-sm font-medium text-primary dark:text-gray-400 hover:text-accent transition-colors" href="/tree-pdf">شجرة PDF</a>
            <a class="text-sm font-medium text-primary dark:text-gray-400 hover:text-accent transition-colors" href="/support">الدعم</a>
          </nav>

          <div class="flex items-center gap-2 dark:border-r dark:border-white/10 dark:pr-4">
            <button id="uiThemeBtn"
              class="flex items-center justify-center w-10 h-10 rounded-full border border-gray-200 dark:border-gold/30 hover:bg-gray-50 dark:hover:bg-gold/10 transition-all"
              type="button" title="تبديل المظهر">
              <span class="material-symbols-outlined text-gray-600 dark-toggle-icon-moon">dark_mode</span>
              <span class="material-symbols-outlined text-gold dark-toggle-icon-sun">light_mode</span>
            </button>

            <a href="/admin"
              class="p-2.5 rounded-full bg-primary text-white hover:bg-[#185366] transition-all shadow-md shadow-primary/20 active:scale-[0.98]
                     dark:bg-gold dark:text-bg-charcoal dark:hover:bg-white dark:shadow-gold/10
                     flex items-center justify-center"
              title="رجوع للوحة الإدارة">
              <span class="material-symbols-outlined text-[22px]">arrow_back</span>
            </a>
          </div>
        </div>

      </div>
    </div>
  </header>

  <main class="flex-1">
    <div class="relative bg-islamic-pattern">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-10 md:py-12">

        <!-- Breadcrumb -->
        <nav class="mb-8 flex flex-wrap gap-2 text-sm text-gray-500 dark:text-gray-500">
          <a class="font-medium hover:text-primary dark:hover:text-gold hover:underline" href="/admin">لوحة الإدارة</a>
          <span class="select-none">/</span>
          <span class="font-bold text-primary dark:text-gold"><%= mode === "new" ? "إضافة شخص" : "تعديل شخص" %></span>
        </nav>

        <!-- Title -->
        <div class="mb-10 text-center">
          <h1 class="text-4xl md:text-5xl font-black tracking-tight text-[#121617] dark:text-white">
            <%= mode === "new" ? "إضافة شخص جديد" : "تعديل بيانات الشخص" %>
          </h1>
          <p class="mt-4 text-lg font-medium text-gray-600 dark:text-gray-300 max-w-3xl mx-auto leading-relaxed">
            أضف البيانات بدقة — ويمكن إضافة أكثر من زوج/زوجة + رفع صورة تلقائيًا.
          </p>
        </div>

        <!-- Form Shell -->
        <div class="relative mx-auto w-full max-w-5xl">
          <div class="relative z-10 overflow-hidden rounded-2xl bg-gradient-to-br from-[#d4af37] via-[#f3e5ab] to-[#c5a028] p-[3px] gold-glow">
            <div class="rounded-[14px] bg-white/80 dark:bg-[#0F1115]/90 p-4 sm:p-6 md:p-8">

              <form method="post" action="<%= mode === 'new' ? '/admin/person/new' : ('/admin/person/' + person.id + '/edit') %>" class="space-y-6">

                <!-- Section: Basic -->
                <section class="rounded-2xl border border-gray-100 bg-white p-5 sm:p-6 shadow-sm dark:border-white/10 dark:bg-white/5">
                  <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3 mb-5">
                    <div>
                      <h2 class="text-xl font-black text-[#121617] dark:text-white">المعلومات الأساسية</h2>
                      <p class="mt-1 text-sm font-bold text-gray-500 dark:text-gray-400">الاسم + الأب + الميلاد + العمل</p>
                    </div>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                      <label class="block text-sm font-extrabold text-gray-700 dark:text-gray-200 mb-2">الاسم</label>
                      <input name="name" required
                        value="<%= person?.name || '' %>"
                        placeholder="مثال: أحمد محمد علي"
                        class="w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-sm font-bold text-gray-800
                               focus:border-primary focus:ring-primary/20
                               dark:border-white/10 dark:bg-[#0b0e12] dark:text-gray-100"/>
                    </div>

                    <div class="md:col-span-2">
                      <label class="block text-sm font-extrabold text-gray-700 dark:text-gray-200 mb-2">الأب</label>
                      <select name="father_id"
                        class="w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-sm font-bold text-gray-800
                               focus:border-primary focus:ring-primary/20
                               dark:border-white/10 dark:bg-[#0b0e12] dark:text-gray-100">
                        <option value="">— بدون —</option>
                        <% persons.forEach(x => { %>
                          <option value="<%= x.id %>" <%= person?.father_id == x.id ? 'selected' : '' %>><%= x.name %></option>
                        <% }) %>
                      </select>
                    </div>

                    <div>
                      <label class="block text-sm font-extrabold text-gray-700 dark:text-gray-200 mb-2">تاريخ الميلاد</label>
                      <input name="birth_date"
                        value="<%= person?.birth_date || '' %>"
                        placeholder="مثال: 2004-08-20"
                        class="w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-sm font-bold text-gray-800
                               focus:border-primary focus:ring-primary/20
                               dark:border-white/10 dark:bg-[#0b0e12] dark:text-gray-100"/>
                    </div>

                    <div>
                      <label class="block text-sm font-extrabold text-gray-700 dark:text-gray-200 mb-2">العمل</label>
                      <input name="job"
                        value="<%= person?.job || '' %>"
                        placeholder="مثال: مهندس / طبيب / ..."
                        class="w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-sm font-bold text-gray-800
                               focus:border-primary focus:ring-primary/20
                               dark:border-white/10 dark:bg-[#0b0e12] dark:text-gray-100"/>
                    </div>
                  </div>
                </section>

                <!-- Section: Spouses -->
                <section class="rounded-2xl border border-gray-100 bg-white p-5 sm:p-6 shadow-sm dark:border-white/10 dark:bg-white/5">
                  <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3 mb-5">
                    <div>
                      <h2 class="text-xl font-black text-[#121617] dark:text-white">الزوج / الزوجة</h2>
                      <p class="mt-1 text-sm font-bold text-gray-500 dark:text-gray-400">أضف واحد أو أكثر — ترتيب السطور هو ترتيب العرض</p>
                    </div>

                    <button type="button" id="addSpouse"
                      class="inline-flex items-center justify-center gap-2 rounded-full bg-primary px-5 py-2.5 text-white font-extrabold shadow-md shadow-primary/20
                             hover:bg-[#185366] active:scale-[0.98]
                             dark:bg-gold dark:text-bg-charcoal dark:hover:bg-white dark:shadow-gold/10 transition-all">
                      <span class="material-symbols-outlined text-[20px]">add</span>
                      إضافة زوج/زوجة
                    </button>
                  </div>

                  <div id="spousesWrap" class="grid gap-3">
                    <% const list = (spouseNames && spouseNames.length) ? spouseNames : [""]; %>
                    <% list.forEach((nm) => { %>
                      <div class="spRow flex flex-col sm:flex-row gap-3 sm:items-center">
                        <input class="w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-sm font-bold text-gray-800
                                      focus:border-primary focus:ring-primary/20
                                      dark:border-white/10 dark:bg-[#0b0e12] dark:text-gray-100"
                               name="spouse_names" value="<%= nm %>" placeholder="مثال: نورة الخولي">
                        <button type="button"
                                class="spRemove inline-flex items-center justify-center gap-2 rounded-xl border border-gray-200 bg-white px-4 py-3 text-sm font-extrabold text-gray-700
                                       hover:bg-gray-50 active:scale-[0.98]
                                       dark:border-white/10 dark:bg-[#0b0e12] dark:text-gray-200 dark:hover:bg-white/5 transition-all sm:w-32">
                          <span class="material-symbols-outlined text-[18px]">delete</span>
                          حذف
                        </button>
                      </div>
                    <% }) %>
                  </div>

                  <div class="mt-4 text-xs font-bold text-gray-500 dark:text-gray-400">
                    نصيحة: لاحقًا يمكننا تحويلها لاختيار من قائمة أو منع التكرار.
                  </div>
                </section>

                <!-- Section: Photo -->
                <section class="rounded-2xl border border-gray-100 bg-white p-5 sm:p-6 shadow-sm dark:border-white/10 dark:bg-white/5">
                  <div class="mb-5">
                    <h2 class="text-xl font-black text-[#121617] dark:text-white">الصورة</h2>
                    <p class="mt-1 text-sm font-bold text-gray-500 dark:text-gray-400">اختيار صورة → رفع تلقائي → يتم ملء photo_url</p>
                  </div>

                  <div class="grid grid-cols-1 lg:grid-cols-[260px_1fr] gap-5 items-start">
                    <div class="flex flex-col gap-3">
                      <div class="rounded-2xl overflow-hidden border border-gray-200 bg-white dark:border-white/10 dark:bg-[#0b0e12]">
                        <img id="photoPreview"
                             src="<%= person?.photo_url || '/images/default.png' %>"
                             alt="معاينة"
                             class="w-full h-64 object-cover"/>
                      </div>

                      <button type="button" id="clearPhoto"
                        class="inline-flex items-center justify-center gap-2 rounded-xl border border-gray-200 bg-white px-4 py-3 text-sm font-extrabold text-gray-700
                               hover:bg-gray-50 active:scale-[0.98]
                               dark:border-white/10 dark:bg-[#0b0e12] dark:text-gray-200 dark:hover:bg-white/5 transition-all">
                        <span class="material-symbols-outlined text-[18px]">backspace</span>
                        مسح
                      </button>

                      <div id="uploadState" class="hidden rounded-xl border px-4 py-3 text-sm font-extrabold"></div>
                    </div>

                    <div class="space-y-4">
                      <div>
                        <label class="block text-sm font-extrabold text-gray-700 dark:text-gray-200 mb-2">الصورة (رفع من الجهاز)</label>
                        <input class="block w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-sm font-bold
                                      file:mr-0 file:ml-3 file:rounded-lg file:border-0 file:bg-primary file:px-4 file:py-2 file:text-white file:font-extrabold hover:file:bg-[#185366]
                                      dark:border-white/10 dark:bg-[#0b0e12] dark:text-gray-100
                                      dark:file:bg-gold dark:file:text-bg-charcoal dark:hover:file:bg-white"
                               type="file" id="photoFile" accept="image/*">
                        <p class="mt-2 text-xs font-bold text-gray-500 dark:text-gray-400">
                          بعد اختيار الصورة سيتم رفعها تلقائيًا ووضع الرابط في خانة <b class="font-amiri">photo_url</b>.
                        </p>
                      </div>

                      <div>
                        <label class="block text-sm font-extrabold text-gray-700 dark:text-gray-200 mb-2">photo_url (يُملأ تلقائيًا بعد الرفع)</label>
                        <input name="photo_url" id="photo_url"
                          value="<%= person?.photo_url || '' %>"
                          placeholder="/uploads/xxx.jpg أو /images/xxx.jpg"
                          class="w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-sm font-bold text-gray-800
                                 focus:border-primary focus:ring-primary/20
                                 dark:border-white/10 dark:bg-[#0b0e12] dark:text-gray-100"/>
                        <p class="mt-2 text-xs font-bold text-gray-500 dark:text-gray-400">
                          يمكنك وضع رابط يدويًا (محلي) مثل: <b class="font-amiri">/images/hazem.jpg</b>
                        </p>
                      </div>
                    </div>
                  </div>
                </section>

                <!-- Section: Notes -->
                <section class="rounded-2xl border border-gray-100 bg-white p-5 sm:p-6 shadow-sm dark:border-white/10 dark:bg-white/5">
                  <div class="mb-4">
                    <h2 class="text-xl font-black text-[#121617] dark:text-white">ملاحظات</h2>
                    <p class="mt-1 text-sm font-bold text-gray-500 dark:text-gray-400">أي تفاصيل إضافية عن الشخص</p>
                  </div>

                  <label class="block text-sm font-extrabold text-gray-700 dark:text-gray-200 mb-2">ملاحظات</label>
                  <textarea name="notes" rows="5"
                    placeholder="مثال: لقب / مكان الإقامة / معلومات إضافية..."
                    class="w-full rounded-2xl border border-gray-200 bg-white px-4 py-3 text-sm font-bold text-gray-800
                           focus:border-primary focus:ring-primary/20
                           dark:border-white/10 dark:bg-[#0b0e12] dark:text-gray-100"><%= person?.notes || '' %></textarea>
                </section>

                <!-- Actions -->
                <div class="flex flex-col sm:flex-row gap-3 sm:justify-end pt-2">
                  <button type="submit"
                    class="inline-flex items-center justify-center gap-2 rounded-full bg-primary px-8 py-4 text-white font-black shadow-lg shadow-primary/30
                           hover:translate-y-[-1px] hover:shadow-xl hover:shadow-primary/40 active:scale-[0.98]
                           dark:bg-gold dark:text-bg-charcoal dark:shadow-gold/20 dark:hover:bg-white transition-all">
                    <span class="material-symbols-outlined text-[22px]">save</span>
                    حفظ
                  </button>

                  <a href="/admin"
                    class="inline-flex items-center justify-center gap-2 rounded-full border border-gray-200 bg-white px-8 py-4 text-gray-800 font-black
                           hover:bg-gray-50 active:scale-[0.98]
                           dark:border-white/10 dark:bg-[#0b0e12] dark:text-gray-200 dark:hover:bg-white/5 transition-all">
                    <span class="material-symbols-outlined text-[22px]">close</span>
                    إلغاء
                  </a>
                </div>

              </form>

            </div>
          </div>

          <div class="absolute -bottom-4 -left-4 -z-0 h-32 w-32 rounded-full bg-accent/20 blur-3xl"></div>
          <div class="absolute -right-4 -top-4 -z-0 h-32 w-32 rounded-full bg-primary/20 blur-3xl"></div>
        </div>

      </div>
    </div>
  </main>

  <footer class="bg-white dark:bg-bg-charcoal border-t border-gray-200 dark:border-white/5 mt-auto">
    <div class="max-w-7xl mx-auto px-4 py-6">
      <p class="text-xs text-gray-400 dark:text-muted-slate font-amiri tracking-wide text-center">
        © ٢٠٢٦ وقف عائلة خاشقجي. جميع الحقوق محفوظة.
      </p>
    </div>
  </footer>

  <script>
    // Theme toggle (same system)
    (function () {
      const btn = document.getElementById("uiThemeBtn");
      function applyTheme(next) {
        document.documentElement.setAttribute("data-theme", next);
        document.documentElement.classList.toggle("dark", next === "dark");
        localStorage.setItem("theme", next);
      }
      btn?.addEventListener("click", () => {
        const current = document.documentElement.getAttribute("data-theme") || "dark";
        applyTheme(current === "dark" ? "light" : "dark");
      });
      applyTheme(localStorage.getItem("theme") || "dark");
    })();

    // ===== Photo upload (same endpoints) =====
    const fileInput = document.getElementById("photoFile");
    const photoUrl = document.getElementById("photo_url");
    const preview = document.getElementById("photoPreview");
    const uploadState = document.getElementById("uploadState");
    const clearBtn = document.getElementById("clearPhoto");

    function setState(text, ok){
      uploadState.classList.remove("hidden");
      uploadState.className = "rounded-xl border px-4 py-3 text-sm font-extrabold " + (ok
        ? "border-emerald-200 bg-emerald-50 text-emerald-800 dark:border-emerald-500/20 dark:bg-emerald-500/10 dark:text-emerald-300"
        : "border-red-200 bg-red-50 text-red-700 dark:border-red-500/20 dark:bg-red-500/10 dark:text-red-300"
      );
      uploadState.textContent = text;
    }

    clearBtn?.addEventListener("click", () => {
      fileInput.value = "";
      photoUrl.value = "";
      preview.src = "/images/default.png";
      uploadState.classList.add("hidden");
    });

    fileInput?.addEventListener("change", async () => {
      if (!fileInput.files || !fileInput.files.length) return;
      const file = fileInput.files[0];

      // quick local preview
      preview.src = URL.createObjectURL(file);
      setState("جاري رفع الصورة...", true);

      const fd = new FormData();
      fd.append("photo", file);

      try{
        const r = await fetch("/admin/upload", { method: "POST", body: fd });
        if (!r.ok) { setState("فشل رفع الصورة", false); return; }

        const data = await r.json();
        photoUrl.value = data.url;
        preview.src = data.url;

        setState("تم رفع الصورة بنجاح — اضغط حفظ لتثبيتها.", true);
      }catch(e){
        setState("حدث خطأ أثناء الرفع", false);
      }
    });

    // ===== Spouses dynamic rows =====
    const wrap = document.getElementById("spousesWrap");

    function bindRemoveButtons(){
      wrap?.querySelectorAll(".spRemove").forEach(btn => {
        btn.onclick = () => {
          const row = btn.closest(".spRow");
          if (!row) return;
          const rows = wrap.querySelectorAll(".spRow");
          if (rows.length === 1){
            row.querySelector("input").value = "";
            return;
          }
          row.remove();
        };
      });
    }
    bindRemoveButtons();

    document.getElementById("addSpouse")?.addEventListener("click", () => {
      const div = document.createElement("div");
      div.className = "spRow flex flex-col sm:flex-row gap-3 sm:items-center";
      div.innerHTML = `
        <input class="w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-sm font-bold text-gray-800
                      focus:border-primary focus:ring-primary/20
                      dark:border-white/10 dark:bg-[#0b0e12] dark:text-gray-100"
               name="spouse_names" value="" placeholder="مثال: فاطمة السيد">
        <button type="button"
                class="spRemove inline-flex items-center justify-center gap-2 rounded-xl border border-gray-200 bg-white px-4 py-3 text-sm font-extrabold text-gray-700
                       hover:bg-gray-50 active:scale-[0.98]
                       dark:border-white/10 dark:bg-[#0b0e12] dark:text-gray-200 dark:hover:bg-white/5 transition-all sm:w-32">
          <span class="material-symbols-outlined text-[18px]">delete</span>
          حذف
        </button>
      `;
      wrap.appendChild(div);
      bindRemoveButtons();
      div.querySelector("input")?.focus();
    });
  </script>
</body>
</html>

