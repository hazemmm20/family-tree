<!doctype html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title><%= mode === "new" ? "إضافة شخص" : "تعديل شخص" %> - لوحة الإدارة</title>

  <!-- Theme must load early -->
  <script src="/theme.js"></script>

  <!-- Fonts + Icons + Tailwind -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200..900&family=Amiri:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

  <!-- ✅ نفس إعدادات لوحة الإدارة (لتوحيد الشكل) -->
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#1f637a",
            accent: "#E3C56F",
            "background-light": "#FBF9F6",
            surface: "#ffffff",

            "background-dark": "#0F1115",
            "surface-dark": "#1A1D21",
            "border-dark": "#2D3139",
            "primary-dark": "#C5A854",
          },
          fontFamily: { display: ["Cairo", "sans-serif"], amiri: ["Amiri", "serif"] },
          borderRadius: {
            "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "2xl": "1rem", "full": "9999px"
          },
        }
      }
    };
  </script>

  <style type="text/tailwindcss">
    @layer base {
      .material-symbols-outlined {
        font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
      }
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 6px; }
      ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

      html.dark ::-webkit-scrollbar-thumb { background: #2D3139; }
      html.dark ::-webkit-scrollbar-thumb:hover { background: #E3C56F; }
    }
  </style>

  <style>
    .pattern {
      background-color: #ffffff;
      background-image:
        radial-gradient(#1f637a 0.5px, transparent 0.5px),
        radial-gradient(#1f637a 0.5px, #ffffff 0.5px);
      background-size: 20px 20px;
      background-position: 0 0, 10px 10px;
      opacity: 0.03;
    }
    html.dark .pattern {
      background-color: transparent;
      background-image:
        radial-gradient(#E3C56F 0.5px, transparent 0.5px),
        radial-gradient(#E3C56F 0.5px, transparent 0.5px);
      background-size: 20px 20px;
      background-position: 0 0, 10px 10px;
      opacity: 0.03;
    }
    html.dark .gold-glow { box-shadow: 0 0 20px rgba(227, 197, 111, 0.05); }
  </style>

  <!-- ✅ Sync theme: data-theme <-> class dark -->
  <script>
    (function () {
      const t = document.documentElement.getAttribute("data-theme") || localStorage.getItem("theme") || "dark";
      document.documentElement.setAttribute("data-theme", t);
      document.documentElement.classList.toggle("dark", t === "dark");

      const obs = new MutationObserver(() => {
        const next = document.documentElement.getAttribute("data-theme") || "dark";
        document.documentElement.classList.toggle("dark", next === "dark");
      });
      obs.observe(document.documentElement, { attributes: true, attributeFilter: ["data-theme"] });
    })();
  </script>
</head>

<body class="font-display antialiased overflow-hidden selection:bg-primary/20 selection:text-primary
             bg-background-light text-slate-800
             dark:bg-background-dark dark:text-slate-300">

<div class="flex h-screen w-full">

  <!-- ✅ SIDEBAR (نفس لوحة الإدارة) -->
  <aside class="relative flex w-72 flex-col border-e z-20 hidden lg:flex
                bg-white border-slate-100 shadow-[4px_0_24px_rgba(0,0,0,0.02)]
                dark:bg-surface-dark dark:border-border-dark dark:shadow-[4px_0_24px_rgba(0,0,0,0.4)]">
    <div class="absolute inset-0 pattern pointer-events-none"></div>

    <div class="relative z-10 flex items-center px-8 border-b
                h-20 border-slate-50
                dark:h-24 dark:border-border-dark/50">
      <div class="flex items-center gap-3 dark:gap-4">
        <div class="flex items-center justify-center size-10 rounded-lg bg-primary text-white
                    dark:size-12 dark:rounded-xl dark:bg-gradient-to-br dark:from-accent dark:to-primary-dark dark:text-black dark:shadow-lg">
          <span class="material-symbols-outlined dark:text-3xl">account_tree</span>
        </div>
        <div>
          <h1 class="font-bold text-lg leading-tight text-primary dark:text-white dark:tracking-wide">عائلة خاشقجي</h1>
          <p class="text-xs font-medium text-slate-400 dark:text-accent/70 dark:uppercase dark:tracking-widest dark:mt-0.5">
            <span class="dark:hidden">لوحة الإدارة</span>
            <span class="hidden dark:inline">لوحة التحكم</span>
          </p>
        </div>
      </div>
    </div>

    <nav class="relative z-10 flex-1 overflow-y-auto px-4 py-6 space-y-8 dark:py-8">

      <div class="flex flex-col gap-1 dark:gap-1.5">
        <p class="px-4 text-xs font-bold text-slate-400 mb-2 dark:text-[11px] dark:text-slate-500 dark:uppercase dark:tracking-widest">
          <span class="dark:hidden">الإدارة</span>
          <span class="hidden dark:inline">النظام</span>
        </p>

        <a class="flex items-center gap-3 px-4 py-3 rounded-xl transition-colors group
                  text-slate-600 hover:bg-slate-50
                  dark:text-slate-400 dark:hover:bg-accent/5 dark:hover:text-accent dark:transition-all"
           href="/admin">
          <span class="material-symbols-outlined text-slate-400 group-hover:text-primary transition-colors
                       dark:text-slate-500 dark:group-hover:text-accent">group</span>
          <span class="font-medium text-sm">إدارة الأفراد</span>
        </a>

        <a class="flex items-center gap-3 px-4 py-3 rounded-xl transition-colors group
                  text-slate-600 hover:bg-slate-50
                  dark:text-slate-400 dark:hover:bg-accent/5 dark:hover:text-accent dark:transition-all"
           href="/admin/pages">
          <span class="material-symbols-outlined text-slate-400 group-hover:text-primary transition-colors
                       dark:text-slate-500 dark:group-hover:text-accent">history_edu</span>
          <span class="font-medium text-sm">إدارة الصفحات</span>
        </a>

        <a class="flex items-center gap-3 px-4 py-3 rounded-xl transition-colors group
                  text-slate-600 hover:bg-slate-50
                  dark:text-slate-400 dark:hover:bg-accent/5 dark:hover:text-accent dark:transition-all"
           href="/admin/honor">
          <span class="material-symbols-outlined text-slate-400 group-hover:text-primary transition-colors
                       dark:text-slate-500 dark:group-hover:text-accent">workspace_premium</span>
          <span class="font-medium text-sm">إدارة السير الذاتية</span>
        </a>

        <a class="flex items-center gap-3 px-4 py-3 rounded-xl transition-colors group
                  text-slate-600 hover:bg-slate-50
                  dark:text-slate-400 dark:hover:bg-accent/5 dark:hover:text-accent dark:transition-all"
           href="/admin/support-messages">
          <span class="material-symbols-outlined text-slate-400 group-hover:text-primary transition-colors
                       dark:text-slate-500 dark:group-hover:text-accent">mail</span>
          <span class="font-medium text-sm">رسائل الدعم</span>
        </a>
      </div>

      <div class="flex flex-col gap-1 dark:gap-1.5">
        <p class="px-4 text-xs font-bold text-slate-400 mb-2 dark:text-[11px] dark:text-slate-500 dark:uppercase dark:tracking-widest">
          روابط الموقع
        </p>

        <a class="flex items-center gap-3 px-4 py-3 rounded-xl transition-colors group
                  text-slate-600 hover:bg-slate-50
                  dark:text-slate-400 dark:hover:bg-accent/5 dark:hover:text-accent"
           href="/">
          <span class="material-symbols-outlined text-slate-400 group-hover:text-primary transition-colors
                       dark:text-slate-500 dark:group-hover:text-accent">account_tree</span>
          <span class="font-medium text-sm">عرض الشجرة</span>
        </a>

        <a class="flex items-center gap-3 px-4 py-3 rounded-xl transition-colors group
                  text-slate-600 hover:bg-slate-50
                  dark:text-slate-400 dark:hover:bg-accent/5 dark:hover:text-accent"
           href="/tree-pdf">
          <span class="material-symbols-outlined text-slate-400 group-hover:text-primary transition-colors
                       dark:text-slate-500 dark:group-hover:text-accent">description</span>
          <span class="font-medium text-sm">عرض PDF</span>
        </a>
      </div>

      <div class="flex flex-col gap-1">
        <p class="px-4 text-xs font-bold text-slate-400 mb-2">النظام</p>
        <form method="post" action="/admin/logout" class="m-0">
          <button type="submit"
            class="w-full flex items-center gap-3 px-4 py-3 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-xl transition-colors group text-start">
            <span class="material-symbols-outlined text-slate-400 group-hover:text-red-500 transition-colors">logout</span>
            <span class="font-medium text-sm">تسجيل خروج</span>
          </button>
        </form>
      </div>

    </nav>
  </aside>

  <!-- ✅ MAIN -->
  <main class="flex-1 flex flex-col min-w-0 relative overflow-hidden bg-background-light dark:bg-background-dark">

    <!-- ✅ TOPBAR (زر الثيم ثابت هنا دائمًا) -->
    <header class="flex items-center justify-between sticky top-0 z-20 backdrop-blur-md border-b
                   h-20 px-4 sm:px-8 bg-white/80 border-slate-200/60
                   dark:h-24 dark:px-10 dark:bg-surface-dark/90 dark:border-border-dark dark:backdrop-blur-xl">
      <div class="flex flex-col justify-center">
        <div class="flex items-center gap-2 text-slate-400 text-xs font-medium mb-1
                    dark:text-slate-500 dark:text-[11px] dark:font-bold dark:uppercase dark:tracking-widest">
          <span>الإدارة</span>
          <span class="material-symbols-outlined text-[10px]">chevron_left</span>
          <span class="text-slate-700 dark:text-slate-400">الأفراد</span>
          <span class="material-symbols-outlined text-[10px]">chevron_left</span>
          <span class="text-primary dark:text-accent font-bold">
            <%= mode === "new" ? "إضافة" : "تعديل" %>
          </span>
        </div>

        <h2 class="text-2xl font-bold text-slate-800 dark:text-white tracking-tight">
          <%= mode === "new" ? "إضافة شخص جديد" : ("تعديل: " + (person?.name || "")) %>
        </h2>
      </div>

      <div class="flex items-center gap-3 sm:gap-4">
        <button id="themeBtn"
          class="flex items-center justify-center size-10 rounded-lg shadow-sm group transition-colors
                 bg-white border border-slate-200 text-slate-600 hover:bg-slate-50
                 dark:bg-surface-dark dark:border-border-dark dark:text-accent dark:hover:border-accent dark:hover:bg-accent/10 dark:shadow-lg active:scale-95"
          type="button" title="تبديل المظهر">
          <span class="material-symbols-outlined text-[20px] dark:hidden">dark_mode</span>
          <span class="material-symbols-outlined text-[24px] hidden dark:block">light_mode</span>
        </button>

        <a href="/admin"
          class="flex items-center gap-2 text-sm font-bold rounded-lg transition-colors
                 px-4 py-2 bg-primary text-white hover:bg-primary/90 shadow-[0_2px_8px_rgba(31,99,122,0.3)]
                 dark:px-5 dark:py-2.5 dark:bg-accent dark:text-black dark:hover:bg-primary-dark dark:shadow-[0_4px_20px_rgba(227,197,111,0.2)] active:scale-95">
          <span class="material-symbols-outlined text-[18px] dark:text-[20px]">arrow_back</span>
          رجوع
        </a>
      </div>
    </header>

    <!-- CONTENT -->
    <div class="flex-1 overflow-y-auto p-4 sm:p-8 dark:p-6 dark:sm:p-10">
      <div class="max-w-5xl mx-auto space-y-6 pb-20">

        <!-- ✅ Form Card -->
        <section class="rounded-2xl border p-4 sm:p-6
                        bg-white border-slate-100 shadow-[0_4px_20px_rgba(0,0,0,0.03)]
                        dark:bg-surface-dark dark:border-border-dark dark:gold-glow">
          <form method="post"
                action="<%= mode === 'new' ? '/admin/person/new' : ('/admin/person/' + person.id + '/edit') %>"
                class="space-y-6">

            <!-- Basic -->
            <div class="rounded-2xl border border-slate-100 bg-slate-50/50 p-4 sm:p-5
                        dark:border-border-dark dark:bg-background-dark/35">
              <div class="flex items-start justify-between gap-3 mb-4">
                <div>
                  <h3 class="text-lg font-black text-slate-900 dark:text-white">المعلومات الأساسية</h3>
                  <p class="text-sm font-bold text-slate-500 dark:text-slate-500">الاسم + الأب + الميلاد + العمل</p>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                  <label class="block text-sm font-extrabold text-slate-700 dark:text-slate-200 mb-2">الاسم</label>
                  <input name="name" required value="<%= person?.name || '' %>"
                         placeholder="مثال: أحمد محمد علي"
                         class="w-full rounded-xl bg-white border border-slate-200 px-4 py-3 text-sm font-bold text-slate-800
                                focus:border-primary focus:ring-0
                                dark:bg-background-dark/40 dark:border-border-dark dark:text-slate-100 dark:focus:border-accent"/>
                </div>

                <div class="md:col-span-2">
                  <label class="block text-sm font-extrabold text-slate-700 dark:text-slate-200 mb-2">الأب</label>
                  <select name="father_id"
                          class="w-full rounded-xl bg-white border border-slate-200 px-4 py-3 text-sm font-bold text-slate-800
                                 focus:border-primary focus:ring-0
                                 dark:bg-background-dark/40 dark:border-border-dark dark:text-slate-100 dark:focus:border-accent">
                    <option value="">— بدون —</option>
                    <% persons.forEach(x => { %>
                      <option value="<%= x.id %>" <%= person?.father_id == x.id ? 'selected' : '' %>><%= x.name %></option>
                    <% }) %>
                  </select>
                </div>

                <div>
                  <label class="block text-sm font-extrabold text-slate-700 dark:text-slate-200 mb-2">تاريخ الميلاد</label>
                  <input name="birth_date" value="<%= person?.birth_date || '' %>" placeholder="مثال: 2004-08-20"
                         class="w-full rounded-xl bg-white border border-slate-200 px-4 py-3 text-sm font-bold text-slate-800
                                focus:border-primary focus:ring-0
                                dark:bg-background-dark/40 dark:border-border-dark dark:text-slate-100 dark:focus:border-accent"/>
                </div>

                <div>
                  <label class="block text-sm font-extrabold text-slate-700 dark:text-slate-200 mb-2">العمل</label>
                  <input name="job" value="<%= person?.job || '' %>" placeholder="مثال: مهندس / طبيب / ..."
                         class="w-full rounded-xl bg-white border border-slate-200 px-4 py-3 text-sm font-bold text-slate-800
                                focus:border-primary focus:ring-0
                                dark:bg-background-dark/40 dark:border-border-dark dark:text-slate-100 dark:focus:border-accent"/>
                </div>
              </div>
            </div>

            <!-- Spouses -->
            <div class="rounded-2xl border border-slate-100 bg-slate-50/50 p-4 sm:p-5
                        dark:border-border-dark dark:bg-background-dark/35">
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
                <div>
                  <h3 class="text-lg font-black text-slate-900 dark:text-white">الزوج / الزوجة</h3>
                  <p class="text-sm font-bold text-slate-500 dark:text-slate-500">أضف واحد أو أكثر — ترتيب السطور هو ترتيب العرض</p>
                </div>

                <button type="button" id="addSpouse"
                        class="inline-flex items-center justify-center gap-2 rounded-lg px-4 py-2 text-sm font-black
                               bg-primary text-white hover:bg-primary/90 active:scale-95
                               dark:bg-accent dark:text-black dark:hover:bg-primary-dark">
                  <span class="material-symbols-outlined text-[20px]">add</span>
                  إضافة
                </button>
              </div>

              <div id="spousesWrap" class="grid gap-3">
                <% const list = (spouseNames && spouseNames.length) ? spouseNames : [""]; %>
                <% list.forEach((nm) => { %>
                  <div class="spRow flex flex-col sm:flex-row gap-3 sm:items-center">
                    <input name="spouse_names" value="<%= nm %>" placeholder="مثال: نورة الخولي"
                           class="w-full rounded-xl bg-white border border-slate-200 px-4 py-3 text-sm font-bold text-slate-800
                                  focus:border-primary focus:ring-0
                                  dark:bg-background-dark/40 dark:border-border-dark dark:text-slate-100 dark:focus:border-accent"/>
                    <button type="button"
                            class="spRemove inline-flex items-center justify-center gap-2 rounded-xl px-4 py-3 text-sm font-extrabold
                                   border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 active:scale-95 sm:w-28
                                   dark:border-border-dark dark:bg-background-dark/40 dark:text-slate-200 dark:hover:bg-white/5">
                      <span class="material-symbols-outlined text-[18px]">delete</span>
                      حذف
                    </button>
                  </div>
                <% }) %>
              </div>

              <div class="mt-3 text-xs font-bold text-slate-500 dark:text-slate-500">
                نصيحة: لاحقًا يمكننا تحويلها لاختيار من قائمة أو منع التكرار.
              </div>
            </div>

            <!-- Photo -->
            <div class="rounded-2xl border border-slate-100 bg-slate-50/50 p-4 sm:p-5
                        dark:border-border-dark dark:bg-background-dark/35">
              <div class="mb-4">
                <h3 class="text-lg font-black text-slate-900 dark:text-white">الصورة</h3>
                <p class="text-sm font-bold text-slate-500 dark:text-slate-500">اختيار صورة → رفع تلقائي → يتم ملء photo_url</p>
              </div>

              <div class="grid grid-cols-1 lg:grid-cols-[260px_1fr] gap-5 items-start">
                <div class="flex flex-col gap-3">
                  <div class="rounded-2xl overflow-hidden border border-slate-200 bg-white
                              dark:border-border-dark dark:bg-background-dark/40">
                    <img id="photoPreview"
                         src="<%= person?.photo_url || '/images/default.png' %>"
                         alt="معاينة"
                         class="w-full h-64 object-cover"/>
                  </div>

                  <button type="button" id="clearPhoto"
                          class="inline-flex items-center justify-center gap-2 rounded-xl px-4 py-3 text-sm font-extrabold
                                 border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 active:scale-95
                                 dark:border-border-dark dark:bg-background-dark/40 dark:text-slate-200 dark:hover:bg-white/5">
                    <span class="material-symbols-outlined text-[18px]">backspace</span>
                    مسح
                  </button>

                  <div id="uploadState" class="hidden rounded-xl border px-4 py-3 text-sm font-extrabold"></div>
                </div>

                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-extrabold text-slate-700 dark:text-slate-200 mb-2">الصورة (رفع من الجهاز)</label>
                    <input type="file" id="photoFile" accept="image/*"
                           class="block w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm font-bold
                                  file:mr-0 file:ml-3 file:rounded-lg file:border-0 file:bg-primary file:px-4 file:py-2 file:text-white file:font-extrabold hover:file:bg-primary/90
                                  dark:border-border-dark dark:bg-background-dark/40 dark:text-slate-100
                                  dark:file:bg-accent dark:file:text-black dark:hover:file:bg-primary-dark"/>
                    <p class="mt-2 text-xs font-bold text-slate-500 dark:text-slate-500">
                      بعد اختيار الصورة سيتم رفعها تلقائيًا ووضع الرابط في خانة <b class="font-amiri">photo_url</b>.
                    </p>
                  </div>

                  <div>
                    <label class="block text-sm font-extrabold text-slate-700 dark:text-slate-200 mb-2">photo_url</label>
                    <input name="photo_url" id="photo_url"
                           value="<%= person?.photo_url || '' %>"
                           placeholder="/uploads/xxx.jpg أو /images/xxx.jpg"
                           class="w-full rounded-xl bg-white border border-slate-200 px-4 py-3 text-sm font-bold text-slate-800
                                  focus:border-primary focus:ring-0
                                  dark:bg-background-dark/40 dark:border-border-dark dark:text-slate-100 dark:focus:border-accent"/>
                    <p class="mt-2 text-xs font-bold text-slate-500 dark:text-slate-500">
                      يمكنك وضع رابط يدويًا (محلي) مثل: <b class="font-amiri">/images/hazem.jpg</b>
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Notes -->
            <div class="rounded-2xl border border-slate-100 bg-slate-50/50 p-4 sm:p-5
                        dark:border-border-dark dark:bg-background-dark/35">
              <div class="mb-3">
                <h3 class="text-lg font-black text-slate-900 dark:text-white">ملاحظات</h3>
                <p class="text-sm font-bold text-slate-500 dark:text-slate-500">أي تفاصيل إضافية عن الشخص</p>
              </div>

              <textarea name="notes" rows="5"
                        placeholder="مثال: لقب / مكان الإقامة / معلومات إضافية..."
                        class="w-full rounded-2xl bg-white border border-slate-200 px-4 py-3 text-sm font-bold text-slate-800
                               focus:border-primary focus:ring-0
                               dark:bg-background-dark/40 dark:border-border-dark dark:text-slate-100 dark:focus:border-accent"><%= person?.notes || '' %></textarea>
            </div>

            <!-- Actions -->
            <div class="flex flex-col sm:flex-row gap-3 sm:justify-end pt-2">
              <button type="submit"
                      class="inline-flex items-center justify-center gap-2 rounded-lg px-6 py-3 text-sm font-black
                             bg-primary text-white hover:bg-primary/90 active:scale-95
                             dark:bg-accent dark:text-black dark:hover:bg-primary-dark">
                <span class="material-symbols-outlined text-[22px]">save</span>
                حفظ
              </button>

              <a href="/admin"
                 class="inline-flex items-center justify-center gap-2 rounded-lg px-6 py-3 text-sm font-black
                        border border-slate-200 bg-white text-slate-800 hover:bg-slate-50 active:scale-95
                        dark:border-border-dark dark:bg-background-dark/40 dark:text-slate-200 dark:hover:bg-white/5">
                <span class="material-symbols-outlined text-[22px]">close</span>
                إلغاء
              </a>
            </div>

          </form>
        </section>

        <div class="text-center text-xs font-bold text-slate-400 dark:text-slate-600">
          © ٢٠٢٦ وقف عائلة خاشقجي. جميع الحقوق محفوظة. حفظ الأنساب والاحتفاء بالتراث.
        </div>

      </div>
    </div>
  </main>
</div>

<script>
  // ✅ Theme toggle (same admin system)
  (function () {
    const btn = document.getElementById("themeBtn");
    function setTheme(next) {
      document.documentElement.setAttribute("data-theme", next);
      document.documentElement.classList.toggle("dark", next === "dark");
      localStorage.setItem("theme", next);
    }
    btn?.addEventListener("click", () => {
      const cur = document.documentElement.getAttribute("data-theme") || "dark";
      setTheme(cur === "dark" ? "light" : "dark");
    });
    setTheme(localStorage.getItem("theme") || (document.documentElement.getAttribute("data-theme") || "dark"));
  })();

  // ===== Photo upload (same endpoints) =====
  const fileInput = document.getElementById("photoFile");
  const photoUrl = document.getElementById("photo_url");
  const preview = document.getElementById("photoPreview");
  const uploadState = document.getElementById("uploadState");
  const clearBtn = document.getElementById("clearPhoto");

  function setState(text, ok){
    uploadState.classList.remove("hidden");
    uploadState.className = "rounded-xl border px-4 py-3 text-sm font-extrabold " + (ok
      ? "border-emerald-200 bg-emerald-50 text-emerald-800 dark:border-emerald-500/20 dark:bg-emerald-500/10 dark:text-emerald-300"
      : "border-red-200 bg-red-50 text-red-700 dark:border-red-500/20 dark:bg-red-500/10 dark:text-red-300"
    );
    uploadState.textContent = text;
  }

  clearBtn?.addEventListener("click", () => {
    fileInput.value = "";
    photoUrl.value = "";
    preview.src = "/images/default.png";
    uploadState.classList.add("hidden");
  });

  fileInput?.addEventListener("change", async () => {
    if (!fileInput.files || !fileInput.files.length) return;
    const file = fileInput.files[0];

    preview.src = URL.createObjectURL(file);
    setState("جاري رفع الصورة...", true);

    const fd = new FormData();
    fd.append("photo", file);

    try{
      const r = await fetch("/admin/upload", { method: "POST", body: fd });
      if (!r.ok) { setState("فشل رفع الصورة", false); return; }

      const data = await r.json();
      photoUrl.value = data.url;
      preview.src = data.url;

      setState("تم رفع الصورة بنجاح — اضغط حفظ لتثبيتها.", true);
    }catch(e){
      setState("حدث خطأ أثناء الرفع", false);
    }
  });

  // ===== Spouses dynamic rows =====
  const wrap = document.getElementById("spousesWrap");

  function bindRemoveButtons(){
    wrap?.querySelectorAll(".spRemove").forEach(btn => {
      btn.onclick = () => {
        const row = btn.closest(".spRow");
        if (!row) return;
        const rows = wrap.querySelectorAll(".spRow");
        if (rows.length === 1){
          row.querySelector("input").value = "";
          return;
        }
        row.remove();
      };
    });
  }
  bindRemoveButtons();

  document.getElementById("addSpouse")?.addEventListener("click", () => {
    const div = document.createElement("div");
    div.className = "spRow flex flex-col sm:flex-row gap-3 sm:items-center";
    div.innerHTML = `
      <input name="spouse_names" value="" placeholder="مثال: فاطمة السيد"
             class="w-full rounded-xl bg-white border border-slate-200 px-4 py-3 text-sm font-bold text-slate-800
                    focus:border-primary focus:ring-0
                    dark:bg-background-dark/40 dark:border-border-dark dark:text-slate-100 dark:focus:border-accent"/>
      <button type="button"
              class="spRemove inline-flex items-center justify-center gap-2 rounded-xl px-4 py-3 text-sm font-extrabold
                     border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 active:scale-95 sm:w-28
                     dark:border-border-dark dark:bg-background-dark/40 dark:text-slate-200 dark:hover:bg-white/5">
        <span class="material-symbols-outlined text-[18px]">delete</span>
        حذف
      </button>
    `;
    wrap.appendChild(div);
    bindRemoveButtons();
    div.querySelector("input")?.focus();
  });
</script>

</body>
</html>
