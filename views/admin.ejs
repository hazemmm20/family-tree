<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>لوحة الإدارة - إدارة الأفراد</title>

  <!-- Theme must load early -->
  <script src="/theme.js"></script>

  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link crossorigin href="https://fonts.gstatic.com" rel="preconnect"/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200..800&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#1f637a",
            accent: "#E3C56F",
            "background-light": "#FBF9F6",
            "surface": "#ffffff",

            "background-dark": "#0F1115",
            "surface-dark": "#1A1D21",
            "border-dark": "#2D3139",
            "primary-dark": "#C5A854",
          },
          fontFamily: { display: ["Cairo", "sans-serif"] },
          borderRadius: {
            "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "2xl": "1rem", "full": "9999px"
          },
        }
      }
    };
  </script>

  <style type="text/tailwindcss">
    @layer base {
      .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }

      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 6px; }
      ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

      html.dark ::-webkit-scrollbar-thumb { background: #2D3139; }
      html.dark ::-webkit-scrollbar-thumb:hover { background: #E3C56F; }
    }

    .pattern {
      background-color: #ffffff;
      background-image:
        radial-gradient(#1f637a 0.5px, transparent 0.5px),
        radial-gradient(#1f637a 0.5px, #ffffff 0.5px);
      background-size: 20px 20px;
      background-position: 0 0, 10px 10px;
      opacity: 0.03;
    }
    html.dark .pattern {
      background-color: transparent;
      background-image:
        radial-gradient(#E3C56F 0.5px, transparent 0.5px),
        radial-gradient(#E3C56F 0.5px, transparent 0.5px);
      background-size: 20px 20px;
      background-position: 0 0, 10px 10px;
      opacity: 0.03;
    }

    html.dark .gold-glow { box-shadow: 0 0 20px rgba(227, 197, 111, 0.05); }
  </style>

  <!-- Sync theme: data-theme <-> class dark -->
  <script>
    (function () {
      const t = document.documentElement.getAttribute("data-theme") || localStorage.getItem("theme") || "dark";
      document.documentElement.setAttribute("data-theme", t);
      document.documentElement.classList.toggle("dark", t === "dark");

      const obs = new MutationObserver(() => {
        const next = document.documentElement.getAttribute("data-theme") || "dark";
        document.documentElement.classList.toggle("dark", next === "dark");
      });
      obs.observe(document.documentElement, { attributes: true, attributeFilter: ["data-theme"] });
    })();
  </script>
</head>

<body class="font-display antialiased overflow-hidden selection:bg-primary/20 selection:text-primary
             bg-background-light text-slate-800
             dark:bg-background-dark dark:text-slate-300">
<div class="flex h-screen w-full">

  <!-- SIDEBAR -->
  <aside class="relative flex w-72 flex-col border-e z-20 hidden lg:flex
                bg-white border-slate-100 shadow-[4px_0_24px_rgba(0,0,0,0.02)]
                dark:bg-surface-dark dark:border-border-dark dark:shadow-[4px_0_24px_rgba(0,0,0,0.4)]">
    <div class="absolute inset-0 pattern pointer-events-none"></div>

    <div class="relative z-10 flex items-center px-8 border-b
                h-20 border-slate-50
                dark:h-24 dark:border-border-dark/50">
      <div class="flex items-center gap-3 dark:gap-4">
        <div class="flex items-center justify-center size-10 rounded-lg bg-primary text-white
                    dark:size-12 dark:rounded-xl dark:bg-gradient-to-br dark:from-accent dark:to-primary-dark dark:text-black dark:shadow-lg">
          <span class="material-symbols-outlined dark:text-3xl">account_tree</span>
        </div>
        <div>
          <h1 class="font-bold text-lg leading-tight text-primary dark:text-white dark:tracking-wide">عائلة خاشقجي</h1>
          <p class="text-xs font-medium text-slate-400 dark:text-accent/70 dark:uppercase dark:tracking-widest dark:mt-0.5">
            <span class="dark:hidden">لوحة الإدارة</span>
            <span class="hidden dark:inline">لوحة التحكم</span>
          </p>
        </div>
      </div>
    </div>

    <nav class="relative z-10 flex-1 overflow-y-auto px-4 py-6 space-y-8 dark:py-8">

      <div class="flex flex-col gap-1 dark:gap-1.5">
        <p class="px-4 text-xs font-bold text-slate-400 mb-2 dark:text-[11px] dark:text-slate-500 dark:uppercase dark:tracking-widest">
          <span class="dark:hidden">الإدارة</span>
          <span class="hidden dark:inline">النظام</span>
        </p>

        <a class="flex items-center gap-3 px-4 py-3 rounded-xl transition-all relative overflow-hidden group
                  bg-primary/5 text-primary ring-1 ring-primary/10 shadow-sm
                  dark:bg-accent/10 dark:text-accent dark:ring-1 dark:ring-accent/20"
           href="/admin">
          <div class="absolute start-0 top-1/2 -translate-y-1/2 w-1 h-8 rounded-e-full
                      bg-accent
                      dark:bg-accent dark:shadow-[0_0_10px_rgba(227,197,111,0.5)]"></div>
          <span class="material-symbols-outlined">group</span>
          <span class="font-bold text-sm">إدارة الأفراد</span>
        </a>

        <a class="flex items-center gap-3 px-4 py-3 rounded-xl transition-colors group
                  text-slate-600 hover:bg-slate-50
                  dark:text-slate-400 dark:hover:bg-accent/5 dark:hover:text-accent dark:transition-all"
           href="/admin/pages">
          <span class="material-symbols-outlined text-slate-400 group-hover:text-primary transition-colors
                       dark:text-slate-500 dark:group-hover:text-accent">history_edu</span>
          <span class="font-medium text-sm">إدارة الصفحات</span>
        </a>

        <a class="flex items-center gap-3 px-4 py-3 rounded-xl transition-colors group
                  text-slate-600 hover:bg-slate-50
                  dark:text-slate-400 dark:hover:bg-accent/5 dark:hover:text-accent dark:transition-all"
           href="/admin/honor">
          <span class="material-symbols-outlined text-slate-400 group-hover:text-primary transition-colors
                       dark:text-slate-500 dark:group-hover:text-accent">workspace_premium</span>
          <span class="font-medium text-sm">إدارة السير الذاتية</span>
        </a>

        <a class="flex items-center gap-3 px-4 py-3 rounded-xl transition-colors group
                  text-slate-600 hover:bg-slate-50
                  dark:text-slate-400 dark:hover:bg-accent/5 dark:hover:text-accent dark:transition-all"
           href="/admin/support-messages">
          <span class="material-symbols-outlined text-slate-400 group-hover:text-primary transition-colors
                       dark:text-slate-500 dark:group-hover:text-accent">mail</span>
          <span class="font-medium text-sm">رسائل الدعم</span>
        </a>
      </div>

      <div class="flex flex-col gap-1 dark:gap-1.5">
        <p class="px-4 text-xs font-bold text-slate-400 mb-2 dark:text-[11px] dark:text-slate-500 dark:uppercase dark:tracking-widest">
          روابط الموقع
        </p>

        <a class="flex items-center gap-3 px-4 py-3 rounded-xl transition-colors group
                  text-slate-600 hover:bg-slate-50
                  dark:text-slate-400 dark:hover:bg-accent/5 dark:hover:text-accent"
           href="/">
          <span class="material-symbols-outlined text-slate-400 group-hover:text-primary transition-colors
                       dark:text-slate-500 dark:group-hover:text-accent">account_tree</span>
          <span class="font-medium text-sm">عرض الشجرة</span>
        </a>

        <a class="flex items-center gap-3 px-4 py-3 rounded-xl transition-colors group
                  text-slate-600 hover:bg-slate-50
                  dark:text-slate-400 dark:hover:bg-accent/5 dark:hover:text-accent"
           href="/tree-pdf">
          <span class="material-symbols-outlined text-slate-400 group-hover:text-primary transition-colors
                       dark:text-slate-500 dark:group-hover:text-accent">description</span>
          <span class="font-medium text-sm">عرض PDF</span>
        </a>
      </div>

      <div class="flex flex-col gap-1">
        <p class="px-4 text-xs font-bold text-slate-400 mb-2">النظام</p>
        <form method="post" action="/admin/logout" class="m-0">
          <button type="submit"
            class="w-full flex items-center gap-3 px-4 py-3 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-xl transition-colors group text-start">
            <span class="material-symbols-outlined text-slate-400 group-hover:text-red-500 transition-colors">logout</span>
            <span class="font-medium text-sm">تسجيل خروج</span>
          </button>
        </form>
      </div>

    </nav>

    <div class="relative z-10 p-4 border-t border-slate-50 dark:border-border-dark/50 dark:p-6">
      <div class="flex items-center gap-3 w-full p-2 rounded-xl text-start">
        <div class="size-10 rounded-full bg-cover bg-center ring-2 ring-white dark:ring-accent/30 shadow-sm dark:size-11 dark:border-2 dark:border-accent/30"
             style="background-image:url('https://lh3.googleusercontent.com/aida-public/AB6AXuDncTuOz-pCokbtv2AWGrnETeGCj6bw_3Yfp6Cf4KFfYwjf7b527Z6oBzc4xi8rdnavAMnlTiXiY86lIQnJqvAFEPN9EMi8fzy-KJD6ZbdslXGsAv_1gLmnmnl42lE2sp19OjaLphfnF05zwxf_-fh1bVDsGImSkKv2DtSUYMvSQmXsfThtsCZXaaCa0tgrN6lla2x2zDSo8e_7wajMsMBnASEm-Unu9luUwXjTPGRYXVGC_dnX6-v_66DSR6bs2O_KSqCSimiwTgU');"></div>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-bold text-slate-800 dark:text-white truncate"><%= admin?.username || "مدير النظام" %></p>
          <p class="text-xs text-slate-500 dark:text-slate-500 truncate dark:text-[11px]">صلاحية: Admin</p>
        </div>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="flex-1 flex flex-col min-w-0 relative overflow-hidden bg-background-light dark:bg-background-dark">
    <header class="flex items-center justify-between sticky top-0 z-20 backdrop-blur-md border-b
                   h-20 px-8 bg-white/80 border-slate-200/60
                   dark:h-24 dark:px-10 dark:bg-surface-dark/90 dark:border-border-dark dark:backdrop-blur-xl">
      <div class="flex flex-col justify-center">
        <div class="flex items-center gap-2 text-slate-400 text-xs font-medium mb-1
                    dark:text-slate-500 dark:text-[11px] dark:font-bold dark:uppercase dark:tracking-widest">
          <span>الإدارة</span>
          <span class="material-symbols-outlined text-[10px]">chevron_left</span>
          <span class="dark:hidden">إدارة الأفراد</span>
          <span class="hidden dark:inline text-accent/70">People Management</span>
        </div>
        <h2 class="text-2xl font-bold text-slate-800 dark:text-white tracking-tight">
          إدارة الأفراد
        </h2>
      </div>

      <div class="flex items-center gap-3 sm:gap-4 dark:gap-4">
        <button id="themeBtn"
          class="flex items-center justify-center size-10 rounded-lg shadow-sm group transition-colors
                 bg-white border border-slate-200 text-slate-600 hover:bg-slate-50
                 dark:bg-surface-dark dark:border-border-dark dark:text-accent dark:hover:border-accent dark:hover:bg-accent/10 dark:shadow-lg active:scale-95"
          type="button" title="تبديل المظهر">
          <span class="material-symbols-outlined text-[20px] dark:hidden">dark_mode</span>
          <span class="material-symbols-outlined text-[24px] hidden dark:block">light_mode</span>
        </button>

        <a href="/admin/person/new"
          class="flex items-center gap-2 text-sm font-bold rounded-lg transition-colors
                 px-5 py-2 bg-primary text-white hover:bg-primary/90 shadow-[0_2px_8px_rgba(31,99,122,0.3)]
                 dark:px-6 dark:py-2.5 dark:bg-accent dark:text-black dark:hover:bg-primary-dark dark:shadow-[0_4px_20px_rgba(227,197,111,0.2)] active:scale-95">
          <span class="material-symbols-outlined text-[18px] dark:text-[20px]">person_add</span>
          إضافة شخص
        </a>
      </div>
    </header>

    <div class="flex-1 overflow-y-auto p-4 sm:p-8 dark:p-6 dark:sm:p-10">
      <div class="max-w-7xl mx-auto space-y-6 dark:space-y-8 pb-20">

        <!-- Search / Tools -->
        <section class="rounded-2xl border p-4 sm:p-5
                        bg-white border-slate-100 shadow-[0_4px_20px_rgba(0,0,0,0.03)]
                        dark:bg-surface-dark dark:border-border-dark dark:gold-glow">
          <div class="flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
            <div class="relative w-full md:max-w-md">
              <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">search</span>
              <input id="searchInput" type="text" placeholder="بحث بالاسم / الأب / الزوج..."
                class="w-full pr-11 pl-4 py-3 rounded-xl bg-slate-50 border border-slate-200 text-slate-700 font-medium focus:ring-0 focus:border-primary
                       dark:bg-background-dark/40 dark:border-border-dark dark:text-slate-200 dark:focus:border-accent"/>
            </div>

            <div class="text-sm font-bold text-slate-500 dark:text-slate-500">
              إجمالي السجلات: <span class="text-slate-800 dark:text-white"><%= persons?.length || 0 %></span>
            </div>
          </div>
        </section>

        <!-- Table -->
        <section class="rounded-2xl overflow-hidden border
                        bg-white border-slate-100 shadow-[0_4px_20px_rgba(0,0,0,0.03)]
                        dark:bg-surface-dark dark:border-border-dark dark:gold-glow">
          <div class="overflow-x-auto">
            <table class="w-full min-w-[980px]">
              <thead class="bg-slate-50 border-b border-slate-100 dark:bg-[#14171B] dark:border-border-dark">
                <tr>
                  <th class="py-4 px-6 text-right text-xs font-bold text-slate-500 uppercase tracking-wider w-24">الصورة</th>
                  <th class="py-4 px-6 text-right text-xs font-bold text-slate-500 uppercase tracking-wider">الاسم</th>
                  <th class="py-4 px-6 text-right text-xs font-bold text-slate-500 uppercase tracking-wider">الأب</th>
                  <th class="py-4 px-6 text-right text-xs font-bold text-slate-500 uppercase tracking-wider">الزوج/الزوجة</th>
                  <th class="py-4 px-6 text-right text-xs font-bold text-slate-500 uppercase tracking-wider">تاريخ الميلاد</th>
                  <th class="py-4 px-6 text-left text-xs font-bold text-slate-500 uppercase tracking-wider w-36">إجراءات</th>
                </tr>
              </thead>

              <tbody id="peopleTableBody" class="divide-y divide-slate-100 dark:divide-border-dark">
                <% for (let i = 0; i < persons.length; i++) { 
                     const p = persons[i];
                     const photo = (p.photo_url && String(p.photo_url).trim()) ? p.photo_url : "/images/default.png";
                %>
                  <tr class="group hover:bg-primary/5 dark:hover:bg-accent/5 transition-colors">
                    <td class="py-4 px-6">
                      <div class="size-11 rounded-full bg-cover bg-center border border-slate-200 shadow-sm
                                  dark:border-border-dark dark:ring-2 dark:ring-accent/15"
                           style="background-image:url('<%= photo %>');"></div>
                    </td>

                    <td class="py-4 px-6">
                      <div class="flex flex-col">
                        <span class="font-bold text-slate-800 dark:text-white text-sm person-name"><%= p.name %></span>
                        <span class="text-xs text-slate-400 mt-1 person-id">ID: <%= p.id %></span>
                      </div>
                    </td>

                    <td class="py-4 px-6 text-sm text-slate-700 dark:text-slate-300 person-father">
                      <%= p.father_name || "-" %>
                    </td>

                    <td class="py-4 px-6 text-sm text-slate-500 dark:text-slate-400 person-spouses">
                      <%= p.spouses_text || "-" %>
                    </td>

                    <td class="py-4 px-6 text-sm text-slate-500 dark:text-slate-400 person-birth">
                      <%= p.birth_date || "-" %>
                    </td>

                    <td class="py-4 px-6">
                      <div class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <a href="/admin/person/<%= p.id %>/edit"
                           class="p-2 rounded-lg text-primary hover:bg-primary/10 dark:text-accent dark:hover:bg-accent/10 transition-colors"
                           title="تعديل">
                          <span class="material-symbols-outlined text-[20px]">edit_square</span>
                        </a>

                        <form method="post" action="/admin/person/<%= p.id %>/delete"
                              style="margin:0"
                              onsubmit="return confirm('متأكد من حذف هذا الشخص؟');">
                          <button type="submit"
                                  class="p-2 rounded-lg text-red-500 hover:bg-red-50 dark:hover:bg-red-500/10 transition-colors"
                                  title="حذف">
                            <span class="material-symbols-outlined text-[20px]">delete</span>
                          </button>
                        </form>
                      </div>
                    </td>
                  </tr>
                <% } %>
              </tbody>
            </table>
          </div>

          <div class="px-6 py-4 border-t border-slate-100 bg-slate-50 text-sm text-slate-500
                      dark:border-border-dark dark:bg-[#14171B] dark:text-slate-500">
            تلميح: استخدم البحث لتصفية النتائج بسرعة.
          </div>
        </section>

      </div>
    </div>
  </main>
</div>

<script>
  // Theme toggle (uses data-theme like your site)
  (function () {
    const btn = document.getElementById("themeBtn");
    function setTheme(next) {
      document.documentElement.setAttribute("data-theme", next);
      document.documentElement.classList.toggle("dark", next === "dark");
      localStorage.setItem("theme", next);
    }
    btn?.addEventListener("click", () => {
      const cur = document.documentElement.getAttribute("data-theme") || "dark";
      setTheme(cur === "dark" ? "light" : "dark");
    });
    setTheme(localStorage.getItem("theme") || (document.documentElement.getAttribute("data-theme") || "dark"));
  })();

  // Search filter (client-side)
  (function(){
    const input = document.getElementById("searchInput");
    const tbody = document.getElementById("peopleTableBody");
    if(!input || !tbody) return;

    input.addEventListener("input", () => {
      const q = input.value.trim().toLowerCase();
      const rows = tbody.querySelectorAll("tr");
      rows.forEach(tr => {
        const name = (tr.querySelector(".person-name")?.textContent || "").toLowerCase();
        const father = (tr.querySelector(".person-father")?.textContent || "").toLowerCase();
        const spouses = (tr.querySelector(".person-spouses")?.textContent || "").toLowerCase();
        const birth = (tr.querySelector(".person-birth")?.textContent || "").toLowerCase();
        const idtxt = (tr.querySelector(".person-id")?.textContent || "").toLowerCase();
        const hay = [name, father, spouses, birth, idtxt].join(" ");
        tr.style.display = (!q || hay.includes(q)) ? "" : "none";
      });
    });
  })();
</script>

</body>
</html>

